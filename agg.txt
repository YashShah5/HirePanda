import csv
from pymongo import MongoClient

# ========== CONFIGURATION ==========
MONGO_URI = "mongodb://username:password@host:port/?authSource=admin"
DB_NAME = "your_database"
ORG_COLLECTION = "ghes_organizations"
REPO_COLLECTION = "ghes_repositories"

# Filters to track across repos
FILTER_FIELDS = [
    "webhooks",
    "runners",
    "pages",
    "actions",
    "branch_protections",
    "issues"
]

# ========== CONNECT TO MONGO ==========
client = MongoClient(MONGO_URI)
db = client[DB_NAME]
orgs_col = db[ORG_COLLECTION]
repos_col = db[REPO_COLLECTION]

# ========== BUILD ORG-LEVEL FILTER MAP ==========
org_filters = {}

for repo in repos_col.find():
    org_name = repo.get("owner_name")
    if not org_name:
        continue

    if org_name not in org_filters:
        # Initialize all filters as False
        org_filters[org_name] = {f: False for f in FILTER_FIELDS}

    for f in FILTER_FIELDS:
        if repo.get(f, False):  # If any repo has True → org-level becomes True
            org_filters[org_name][f] = True

# ========== WRITE OUTPUT TO CSV ==========
output_file = "orgs_with_filters.csv"
with open(output_file, "w", newline="") as f:
    writer = csv.writer(f)
    header = ["org_name", "org_url"] + FILTER_FIELDS
    writer.writerow(header)

    for org in orgs_col.find():
        org_name = org.get("org_name")
        org_url = org.get("org_url")

        # Skip if org isn't in filter map (no repos or unmatched name)
        if org_name not in org_filters:
            continue

        row = [org_name, org_url]
        for f in FILTER_FIELDS:
            row.append(str(org_filters[org_name][f]).lower())  # 'true' or 'false'
        writer.writerow(row)

print(f"✅ Exported to {output_file}")
